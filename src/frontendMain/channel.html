<!doctype html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <title>Chess with video</title>
    <base href="../"/>
    <link rel="stylesheet" href="https://unpkg.com/purecss@2.0.3/build/pure-min.css"
          integrity="sha384-cg6SkqEOCV1NbJoCu11+bm0NvBRc8IYLRGXkmNrqUBfTjmMYwNKPWBTIKyw9mHNJ" crossorigin="anonymous">
    <link rel="stylesheet" href="https://unpkg.com/purecss@2.0.3/build/grids-responsive-min.css"/>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css"
          integrity="sha384-q94+BZtLrkL1/ohfjR8c6L+A6qzNH9R2hBLwyoAfu3i/WCvQjzL2RQJ3uNHDISdU" crossorigin="anonymous">
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<style type="text/css">
    /*noinspection CssUnusedSymbol*/
    .highlight { /* used for highlighting last move */
        box-shadow: inset 0 0 3px 3px blue;
    }
    .l-box {
        padding: 1em;
    }
</style>
<body>

<div id="mainDiv" class="pure-g">
    <div class="pure-u-1 pure-u-xl-1-2">
        <div id="leftSide" class="l-box">
            <div id="colorSelection">
                <div class="l-box">
                    Select your side:
                </div>
                <table class="l-box">
                    <tbody>
                    <tr>
                        <td><a class="pure-button" onclick="selectWhite()">White</a></td>
                        <td><a class="pure-button" onclick="selectBlack()">Black</a></td>
                    </tr>
                    <tr>
                        <td><img src="static/wK.png" border="0" onclick="selectWhite()"/></td>
                        <td><img src="static/bK.png" border="0" onclick="selectBlack()"/></td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <div>
                <div id="myBoard" class="l-box" style="width: 600px; "></div>
                <button class="pure-button" onclick="resetBoard()">Reset board</button>
                <button id="toggleDetails" class="pure-button" onclick="toggleDetails()">Show details</button>
            </div>
            <div id="gameDetails" style="display: none;">
                <label>Status:</label>
                <div id="status"></div>
                <label>FEN:</label>
                <div id="fen"></div>
                <label>PGN:</label>
                <div id="pgn"></div>
            </div>
        </div>
    </div>
    <div class="pure-u-1 pure-u-xl-1-2">
        <div id="meet" class="l-box"></div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" crossorigin="anonymous"></script>
<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"
        integrity="sha384-8Vi8VHwn3vjQ9eUHUxex3JSN/NFqUg3QbPyX8kWyb93+8AC/pPWTzj+nHtbC5bxD"
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.js"
        integrity="sha384-s3XgLpvmHyscVpijnseAmye819Ee3yaGa8NxstkJVyA6nuDFjt59u1QvuEl/mecz"
        crossorigin="anonymous"></script>
<script src='https://meet.jit.si/external_api.js'></script>
<script>

    var board = null;
    var game = new Chess();
    var $status = $('#status')
    var $fen = $('#fen');
    var $pgn = $('#pgn');
    var $boardUi = $('#myBoard');
    let myColor;
    const roomName = location.pathname.match(/\/room\/(.*)/)[1];
    let detailsHidden = true;
    let $details = $('#gameDetails');
    let $toggleDetailsButton = $('#toggleDetails');

    function onDragStart(source, piece, position, orientation) {
        if (game.turn() !== myColor || game.game_over())
            return false;

        // only pick up pieces for the side to move
        if ((game.turn() === 'w' && piece.search(/^b/) !== -1) ||
            (game.turn() === 'b' && piece.search(/^w/) !== -1)) {
            return false
        }
    }

    function getPromotionPiece(move) {
        if (move.piece === 'p' &&
            ((game.turn() === 'b' && move.to[1] === '8') || (game.turn() === 'w' && move.to[1] === '1')))
            return 'q';
        return '';
    }

    function onDrop(source, target) {
        // see if the move is legal
        var move = game.move({
            from: source,
            to: target,
            promotion: 'q' // NOTE: always promote to a queen for example simplicity
        });

        // illegal move
        if (move === null) return 'snapback';

        highlightLastMove(source, target);

        updateStatus();
        socket.send(source + target + getPromotionPiece(move));
    }

    function highlightLastMove(fromField, toField) {
        const squareClass = 'square-55d63';

        $boardUi.find('.' + squareClass).removeClass('highlight')
        $boardUi.find('.square-' + fromField).addClass('highlight');
        $boardUi.find('.square-' + toField).addClass('highlight');
    }

    // update the board position after the piece snap
    // for castling, en passant, pawn promotion
    function onSnapEnd() {
        board.position(game.fen())
    }

    function updateStatus() {
        var status = ''

        var moveColor = 'White'
        if (game.turn() === 'b') {
            moveColor = 'Black'
        }

        // checkmate?
        if (game.in_checkmate()) {
            status = 'Game over, ' + moveColor + ' is in checkmate.'
        }

        // draw?
        else if (game.in_draw()) {
            status = 'Game over, drawn position'
        }

        // game still on
        else {
            status = 'You play ' + myColor + ', ' + moveColor + ' to move'

            // check?
            if (game.in_check()) {
                status += ', ' + moveColor + ' is in check'
            }
        }

        $status.html(status)
        $fen.html(game.fen())
        $pgn.html(game.pgn())
    }

    function setupVideo() {
        const domain = 'meet.jit.si';
        const options = {
            roomName: roomName,
            width: 700,
            height: 700,
            parentNode: document.querySelector('#meet'),
            interfaceConfigOverwrite: {
                TOOLBAR_BUTTONS: [
                    'microphone', 'camera', 'desktop', 'embedmeeting',
                    'fodeviceselection', 'hangup', 'profile', 'chat',
                    'livestreaming', 'etherpad', 'settings',
                    'videobackgroundblur', 'help', 'security'
                ]
            }
        };
        const api = new JitsiMeetExternalAPI(domain, options);
        api.addEventListener('cameraError', function (event) {
            console.log('VC Camera error ' + event)
        });
    }

    function selectWhite() {
        myColor = 'w';
        updateStatus();
        board.orientation('white');
        $boardUi.show();
        $('#colorSelection').hide();
    }

    function selectBlack() {
        myColor = 'b';
        updateStatus();
        board.orientation('black');
        $boardUi.show();
        $('#colorSelection').hide();
    }

    function resetBoard() {
        socket.send("reset");
        $('#colorSelection').show();
    }

    function toggleDetails() {
        if (detailsHidden) {
            detailsHidden = false;
            $details.show();
            $toggleDetailsButton.html("Hide details");
        } else {
            detailsHidden = true;
            $details.hide();
            $toggleDetailsButton.html("Show details");
        }
    }

    function handleNewMove(event) {
        const received = event.data;
        console.log("Received: " + received)

        if (received.startsWith("fen")) {
            const fen = received.split("|")[1];
            game.load(fen);
        } else if (received === "reset") {
            let startingFen = "rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1";
            game.load(startingFen);
        } else {
            const source = received.substring(0, 2);
            const target = received.substring(2, 4);
            game.move({
                from: source,
                to: target,
                promotion: 'q' // NOTE: always promote to a queen for example simplicity
            });
            highlightLastMove(source, target);
        }

        board.position(game.fen())
        updateStatus()
    }

    function connectWebSocket() {
        const host = location.origin.replace(/^http/, 'ws');
        const newWebSocket = new WebSocket(host + "/ws/" + roomName);

        newWebSocket.onopen = () => console.log("[open] Connection established")
        newWebSocket.onmessage = event => handleNewMove(event);

        return newWebSocket;
    }

    function keepAlive() {
        if (socket.readyState === socket.CLOSED) {
            console.log("Socket is closed. Trying to reconnect...")
            socket = connectWebSocket();
            if (socket.readyState === socket.OPEN) {
                socket.send("ping")
            }
        }
    }

    const config = {
        draggable: true,
        position: 'start',
        onDragStart: onDragStart,
        onDrop: onDrop,
        onSnapEnd: onSnapEnd,
        pieceTheme: 'static/{piece}.png'
    }
    board = Chessboard('myBoard', config)

    updateStatus();

    let socket = connectWebSocket();

    setInterval(keepAlive, 2000);

    setupVideo();

</script>
</body>
</html>

